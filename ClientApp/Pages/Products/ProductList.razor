@page "/products"
@using ClientApp.Models
@using ClientApp.Services
@inject NavigationManager Navigation
@inject ProductService ProductService
@inject AuthTokenService TokenService
@inject Microsoft.JSInterop.IJSRuntime JSRuntime



<h3 class="text-2xl font-bold mb-4">Products</h3>

<!-- Search and Filter Section -->
<div class="d-flex mb-3 gap-2">
    <input type="text" class="form-control w-50" placeholder="Search products..." @bind="searchQuery" />
    <select class="form-select w-25" @bind="selectedCategory">
        <option value="">All Categories</option>
        <option value="Tech & Electronics">Tech & Electronics</option>
        <option value="Office & Accessories">Office & Accessories</option>
        <option value="Home & Lifestyle">Home & Lifestyle</option>
    </select>

    <button class="btn btn-primary" @onclick="SearchProducts">Search</button>
    <button class="btn btn-secondary" @onclick="ClearSearch">Clear</button>
</div>

@if (products is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Name</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Category</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var p in products.Data)
            {
                <tr>
                    <td>
                        <a href="@($"/products/{p.ProductId}")" class="text-decoration-none"> @p.Name</a>
                    </td>
                    <td>@p.Price</td>
                    <td>@p.Stock</td>
                    <td>@p.Category</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-2" @onclick="() => EditProduct(p.ProductId)">Edit</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteProduct(p.ProductId)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div class="mt-3 d-flex justify-content-between align-items-center">
        <button class="btn btn-primary" @onclick="PrevPage" disabled="@(!CanPrev)">Previous</button>
        <span>Page @pageNumber of @products.TotalPages</span>
        <button class="btn btn-primary" @onclick="NextPage" disabled="@(!CanNext)">Next</button>
    </div>
}

<button class="btn btn-primary mt-3" @onclick="Logout">Logout</button>

@code
{
    private PagedResponse<ProductReadDto>? products;
    private int pageNumber = 1;
    private int pageSize = 5;
    

    private bool CanPrev => pageNumber > 1;
    private bool CanNext => products is not null && pageNumber < products.TotalPages;

    private string? searchQuery;
    private string? selectedCategory;

    // When the page loads, display the first page of products
    protected override async Task OnInitializedAsync()
    {
        // Check if user is logged in
        var token = await TokenService.GetTokenAsync();
        if(string.IsNullOrEmpty(token)){
            Navigation.NavigateTo("/login", forceLoad:true);
            return;
        }

        // Extract the current URL
        var uri = new Uri(Navigation.Uri);

        // Parse query parameters (e.g ?page=2)
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);

        // If the "page" query exists, read it; otherwise, stay on page 1
        if (query.TryGetValue("page", out var pageValue) && int.TryParse(pageValue, out var parsedPage))
        {
            pageNumber = parsedPage;
        }

        // Load the products for the page
        await LoadProductsAsync();


    }

    // Fetch products from API
    private async Task LoadProductsAsync()
    {
        products = await ProductService.GetPaginatedAsync(pageNumber, pageSize);

        // Update the browser URL (adds ?page=x without reloading)
        var uri = Navigation.GetUriWithQueryParameter("page", pageNumber);
        Navigation.NavigateTo(uri, forceLoad: false);
    }

    // Navigate to the next page
    private async Task NextPage()
    {
        if (CanNext)
        {
            pageNumber++;
            await LoadProductsAsync();
        }
    }

    // Navigate to the previous page
    private async Task PrevPage()
    {
        if (CanPrev)
        {
            pageNumber--;
            await LoadProductsAsync();
        }
    }

    private void EditProduct(int id) => Navigation.NavigateTo($"/products/edit/{id}");

    private async Task DeleteProduct(int id)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete this product?");

        if (confirmed)
        {
            await ProductService.DeleteAsync(id);
            await LoadProductsAsync();
        }
    }

    private async Task SearchProducts()
    {
        var results = await ProductService.SearchAsync(searchQuery, selectedCategory);

        products = new PagedResponse<ProductReadDto>
        {
            Data = results.ToList(),
            TotalCount = results.Count(),
            PageNumber = 1,
            PageSize = results.Count(),
            TotalPages = 1
        };
    }

    private async Task ClearSearch()
    {
        searchQuery = string.Empty;
        selectedCategory = string.Empty;
        await LoadProductsAsync();
    }

    private async Task Logout()
    {
        await TokenService.RemoveTokenAsync();
        Navigation.NavigateTo("/login");
    }
}