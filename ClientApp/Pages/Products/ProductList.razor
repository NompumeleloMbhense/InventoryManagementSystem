@page "/products"
@using ClientApp.Models
@using ClientApp.Services
@inject NavigationManager Navigation
@inject ProductService ProductService
@inject Microsoft.JSInterop.IJSRuntime JSRuntime



<h3 class="text-2xl font-bold mb-4">Products</h3>

@if (products is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Name</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Category</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var p in products.Data)
            {
                <tr>
                    <td>
                        <a href="@($"/products/{p.ProductId}")" class="text-decoration-none"> @p.Name</a>
                    </td>
                    <td>@p.Price</td>
                    <td>@p.Stock</td>
                    <td>@p.Category</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-2" @onclick="() => EditProduct(p.ProductId)">Edit</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteProduct(p.ProductId)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div class="mt-3 d-flex justify-content-between align-items-center">
        <button class="btn btn-primary" @onclick="PrevPage" disabled="@(!CanPrev)">Previous</button>
        <span>Page @pageNumber of @products.TotalPages</span>
        <button class="btn btn-primary" @onclick="NextPage" disabled="@(!CanNext)">Next</button>
    </div>
}


@code
{
    private PagedResponse<ProductReadDto>? products;
    private int pageNumber = 1;
    private int pageSize = 5;

    // For feedback messages
    private string? message;
    private bool isError;

    private bool CanPrev => pageNumber > 1;
    private bool CanNext => products is not null && pageNumber < products.TotalPages;

    // When the page loads, display the first page of products
    protected override async Task OnInitializedAsync()
    {
        // Extract the current URL
        var uri = new Uri(Navigation.Uri);

        // Parse query parameters (e.g ?page=2)
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);

        // If the "page" query exists, read it; otherwise, stay on page 1
        if (query.TryGetValue("page", out var pageValue) && int.TryParse(pageValue, out var parsedPage))
        {
            pageNumber = parsedPage;
        }

        // Load the products for the page
        await LoadProductsAsync();
    }

    // Fetch products from API
    private async Task LoadProductsAsync()
    {
        products = await ProductService.GetPaginatedAsync(pageNumber, pageSize);

        // Update the browser URL (adds ?page=x without reloading)
        var uri = Navigation.GetUriWithQueryParameter("page", pageNumber);
        Navigation.NavigateTo(uri, forceLoad: false);
    }

    // Navigate to the next page
    private async Task NextPage()
    {
        if (CanNext)
        {
            pageNumber++;
            await LoadProductsAsync();
        }
    }

    // Navigate to the previous page
    private async Task PrevPage()
    {
        if (CanPrev)
        {
            pageNumber--;
            await LoadProductsAsync();
        }
    }

    private void EditProduct(int id) => Navigation.NavigateTo($"/products/edit/{id}");

    private async Task DeleteProduct(int id)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete this product?");
        
        if (confirmed)
        {
            await ProductService.DeleteAsync(id);
            await LoadProductsAsync();
        }
    }
}